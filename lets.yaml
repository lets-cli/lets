shell: bash

mixins:
  - build.yaml
  - -lets.my.yaml

plugins:
  docker-push-pull:
    repo: lets-cli/lets-plugin-docker-push-pull
    # TODO version is hashed for cache
    version: v0.0.45
    #version: latest
    # TODO url is hashed for cache
    url: "https://github.com/lets-cli/lets/releases/download/{{.Version}}/lets_{{.Os}}_{{.Arch}}.tar.gz"
    # TODO if bin specified, url is ignored
    bin: ../lets-plugin-docker-push-pull/docker-push-pull

env:
    NAME: "max"
    AGE: 27
    CURRENT_UID:
      sh: echo "`id -u`:`id -g`"
    NGINX_DEV:
      checksum: [go.mod, go.sum]
    LINT_TAG:
      checksum: [docker/lint.Dockerfile]

commands:
  build-image:
    plugins:
      docker-push-pull:
        registry_url: "https://registry.evo.dev"
        build_context: "/home/max/code/lets-workspace/lets"
        dockerfile: docker/lint.Dockerfile
#         image: registry.evo.dev/core-team/company-stats/backend
        image: lets-lint
        tag: "123" # TODO has to resolve env
#         tag: ${LINT_TAG} # TODO has to resolve env
        target: dev

  release:
    description: Create tag and push
    options: |
      Usage: lets release <version> --message=<message>
      Options:
        <version>       Set version
        --message=<message>, -m    Release message
    cmd: |
      git tag -a v${LETSOPT_VERSION} -m "${LETSOPT_MESSAGE}"
      git push --tags

  test-unit:
    description: Run unit tests
    depends: [build-lets-image]
    cmd:
      - docker-compose
      - run
      - --rm
      - test

  test-bats:
    description: Run bats tests
    depends: [build-lets-image]
    options: |
      Usage: lets test-bats [<test>]
    cmd: |
      docker-compose run --rm test-bats

  test:
    description: Run unit and bats tests
    depends:
      - test-unit
      - test-bats

  coverage:
    description: Run tests for lets
    options: |
      Usage: lets coverage [--html]
      Options: --html
    cmd: |
      if [[ -n ${LETSOPT_HTML} ]]; then
        go tool cover -html=coverage.out
      else
        go tool cover -func=coverage.out
      fi

  staticcheck:
    description: Run staticcheck for lets. Staticcheck is go vet on steroids
    depends: [build-lets-image]
    cmd:
      docker-compose run --rm staticheck

  lint:
    description: Run golint-ci
    depends: [build-lint-image]
    cmd:
      - docker-compose run --rm lint

  fmt:
    description: Run sfmt
    cmd:
      go fmt ./...

  build-and-install:
    description: Build and install lets-dev version from source code
    options: |
      Usage: lets build-and-install [--path=<path>]
      Options:
        --path=<path>, -p    Custom executable path
    cmd: |
      VERSION=$(git describe)
      PATH2LETSDEV="/usr/local/bin"

      if [[ -n ${LETSOPT_PATH} ]]; then
        PATH2LETSDEV=$LETSOPT_PATH
      fi

      go build -ldflags="-X main.version=${VERSION:1}-dev" -o lets-dev *.go && \
      sudo mv ./lets-dev $PATH2LETSDEV/lets-dev && \
      echo " - build 'lets-dev' successfully installed in ${PATH2LETSDEV}"

  publish-docs:
    work_dir: docs
    cmd: npm run doc:deploy

  run-docs:
    work_dir: docs
    cmd: npm start
