<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Lets Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Lets Blog Atom Feed"><title data-react-helmet="true">Architecture | Lets</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Architecture | Lets"><meta data-react-helmet="true" name="description" content="Architecture diagram"><meta data-react-helmet="true" property="og:description" content="Architecture diagram"><meta data-react-helmet="true" property="og:url" content="https://lets-cli.org/docs/architecture"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://lets-cli.org/docs/architecture"><link rel="stylesheet" href="/styles.9cdbff9f.css">
<link rel="preload" href="/styles.3f0da536.js" as="script">
<link rel="preload" href="/runtime~main.ff34883b.js" as="script">
<link rel="preload" href="/main.53e0f38c.js" as="script">
<link rel="preload" href="/1.ace01047.js" as="script">
<link rel="preload" href="/34.896e33e9.js" as="script">
<link rel="preload" href="/35.e11efc0a.js" as="script">
<link rel="preload" href="/935f2afb.fcce4eaf.js" as="script">
<link rel="preload" href="/33.565f5e04.js" as="script">
<link rel="preload" href="/5281b7a2.0470e55d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Lets Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.png" alt="Lets Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Lets</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/getting_started">Getting Started</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://github.com/lets-cli/lets" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Lets Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.png" alt="Lets Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Lets</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/getting_started">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/lets-cli/lets" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/what_is_lets">What is lets ?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/installation">Installation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/getting_started">Getting started with Lets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/completion">Shell completion</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Basic usage</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/basic_usage">Basic usage</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Advanced usage</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/advanced_usage">Advanced usage</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Config format</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/config">Config reference</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Environment</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/env">Lets environment</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Examples</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/examples">Examples</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/example_js">Example for JavaScript/Node.js</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Best practices</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/best_practices">Best practices</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Changelog</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/changelog">Changelog</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">IDE support</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ide_support">IDE/Text editors support</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Development</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/architecture">Architecture</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/development">Development</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/contribute">Contribute</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Architecture</h1></header><div class="markdown"><p><img alt="Architecture diagram" src="/assets/images/lets-architecture-diagram-ac44548f80a96c907e3331fe90c31144.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="parser"></a>Parser<a class="hash-link" href="#parser" title="Direct link to heading">#</a></h2><p>At the start of lets application, parser tries to find <code>lets.yaml</code> file starting from current directory up to the <code>/</code>.</p><p>When config file is found, parser tries to read/parse and validate yaml config.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="mixins"></a>Mixins<a class="hash-link" href="#mixins" title="Direct link to heading">#</a></h4><p>Lets has feature called <a href="/docs/config#mixins">mixins</a>. When parser meets <code>mixins</code> directive,
it basically repeats all read/parse logic on minix files.</p><p>Since mixin config files have some limitations, although they are parsed the same way, validation is a bit different.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="how-parsing-works-"></a>How parsing works ?<a class="hash-link" href="#how-parsing-works-" title="Direct link to heading">#</a></h3><p><code>config.go:Config</code> struct implements <code>UnmarshalYAML</code> function, so when <code>yaml.Unmarshal</code> called with <code>Config</code> instance passed in,
custom unmarshalling code is executed.</p><p>Its common to make some normalization of commands and its data during parsing phase so the rest of the code
does not have to do any kind of normalization on its own.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="validation"></a>Validation<a class="hash-link" href="#validation" title="Direct link to heading">#</a></h3><p>There are two validation phases.</p><p>First validation phase happens during unmarshalling and checks if:</p><ul><li>directives names valid</li><li>directives types valid (array, map, string, number, etc.)</li><li>references to command in <code>depends</code> directive points to existing commands </li></ul><p>Second phase happens after we ensured that config is syntactically and semantically correct.</p><p>Int the second phase we are checking:</p><ul><li>config version</li><li>circular dependencies in commands</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="cobra-cli-framework"></a>Cobra CLI Framework<a class="hash-link" href="#cobra-cli-framework" title="Direct link to heading">#</a></h2><p>We are using <code>Cobra</code> CLI framework and delegating to it most of the work related to parsing
command line arguments, help messages etc.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="binding-our-config-with-cobra"></a>Binding our config with Cobra<a class="hash-link" href="#binding-our-config-with-cobra" title="Direct link to heading">#</a></h3><p>Now we have to bind our config to <code>Cobra</code>.</p><p>Cobra has a concept of <code>cobra.Command</code>. It is a representation of command in CLI application, for example:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-shell codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> commit</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> pull</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><code>git</code> is a CLI applications and
<code>commit</code> and <code>pull</code> are commands.</p><p>In a traditional <code>lets</code> application commands will be what is declared in <code>lets.yaml</code> commands section.</p><p>To achieve this we are creating so-called <code>root</code> command and <code>subcommands</code> from config.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="root-command"></a>Root command<a class="hash-link" href="#root-command" title="Direct link to heading">#</a></h4><p>Root command is responsible for:</p><ul><li><code>lets</code> own command line flags such as <code>--version</code>, <code>--upgrade</code>, <code>--help</code> and so on.</li><li><code>lets</code> commands autocompletion in terminal</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="subcommands"></a>Subcommands<a class="hash-link" href="#subcommands" title="Direct link to heading">#</a></h4><p>Subcommand is created from our <code>Config.Commands</code> (see <code>initSubCommands</code> function).</p><p>In subcommand&#x27;s <code>RunE</code> callback we are parsing/validation/normalizing command line arguments for this subcommand
and then finally executing command with <code>Runner</code>.</p><p>Since we are using <code>docopt</code> as an argument parser for subcommands, we don&#x27;t let <code>Cobra</code> parse and interpret args,
and instead we are passing raw arguments as is to <code>Runner</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="runner"></a>Runner<a class="hash-link" href="#runner" title="Direct link to heading">#</a></h2><p><code>Runner</code> is responsible for:</p><ul><li>parsing and preparing args using <code>docopt</code></li><li>calculating and storing command&#x27;s checksums</li><li>executing other commands from <code>depends</code> section</li><li>preparing environment </li><li>running command in OS using <code>exec.Command</code></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/lets-cli/lets/edit/master/docs/docs/architecture.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/ide_support"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« IDE/Text editors support</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/development"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Development Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#parser" class="table-of-contents__link">Parser</a><ul><li><a href="#how-parsing-works-" class="table-of-contents__link">How parsing works ?</a></li><li><a href="#validation" class="table-of-contents__link">Validation</a></li></ul></li><li><a href="#cobra-cli-framework" class="table-of-contents__link">Cobra CLI Framework</a><ul><li><a href="#binding-our-config-with-cobra" class="table-of-contents__link">Binding our config with Cobra</a></li></ul></li><li><a href="#runner" class="table-of-contents__link">Runner</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting_started">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/lets-cli" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Lets, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.3f0da536.js"></script>
<script src="/runtime~main.ff34883b.js"></script>
<script src="/main.53e0f38c.js"></script>
<script src="/1.ace01047.js"></script>
<script src="/34.896e33e9.js"></script>
<script src="/35.e11efc0a.js"></script>
<script src="/935f2afb.fcce4eaf.js"></script>
<script src="/33.565f5e04.js"></script>
<script src="/5281b7a2.0470e55d.js"></script>
</body>
</html>